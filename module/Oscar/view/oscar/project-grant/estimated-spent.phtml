<div class="container-fluid">
    <h1>Dépenses prévisionnelles</h1>
    <div id="app" style="display: none">
        <transition name="fade">
            <div class="error overlay" v-if="error">
                <div class="overlay-content">
                    <h3>
                        <i class="icon-warning-empty"></i> Impossible d'enregistrer les données
                    </h3>
                    <pre>
                        Le serveur a répondu :
                        {{ error }}
                    </pre>
                    <a href="#" @click="error = null" class="btn btn-sm btn-default btn-xs">
                        <i class="icon-cancel-circled"></i>
                        Fermer</a>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div class="pending overlay" v-if="loadingMsg">
                <div class="overlay-content">
                    <i class="icon-spinner animate-spin"></i>
                    {{ loadingMsg }}
                </div>
            </div>
        </transition>

        <section class="previsionnel" v-if="values">
            <form action="" method="post" @submit.prevent="handlerSave">
                <header class="line" >
                    <span class="cell cell-code">
                            <code class="code">code</code>
                        </span>
                    <strong class="cell">Intitulé</strong>
                    <span class="year cell" v-for="year in years">
                            {{ year }}
                        </span>
                    <span class="total cell"> TOTAL</span>
                </header>

                <section class="masse" v-for="masse in byMasse">
                    <article class="line">
                        <span class="cell cell-code">{{ masse.code }}</span>
                        <strong class="cell cell-label">{{ masse.label }}</strong>
                        <span class="year cell" v-for="year in years">
                            {{ year }}
                        </span>
                        <span class="total cell">{{ totaux[masse.code] }}</span>
                    </article>

                    <article class="line" v-for="compte in masse.comptes" :class="'marge-' + compte.code.length">
                        <span class="cell cell-code">{{ compte.code }}</span>
                        <strong class="cell cell-label">{{ compte.label }}</strong>
                        <span class="year cell" v-for="year in compte.years">
                            <input type="text" :name="'previsionnel['+compte.code+']['+year.label+']'"
                                   @change="handlerChange($event, compte.code, year.label)"
                                   class="form-control total"
                                   :value="year.value"
                                   :placeholder="'Total pour ' + year.label" style="display: inline-block"/>
                        </span>
                        <span class="total cell">{{ total(compte.code) }}</span>
                    </article>


                </section>

                <nav>
                    <button><i class="icon-floppy"></i>Enregistrer</button>
                </nav>
            </form>
        </section>
    </div>
    <style>
        .previsionnel {
            padding: 1em;
            background: #fff;
        }
        .line {
            display: flex;
            border-bottom: solid thin #e0e0e0;
        }
        .line .cell {
            flex: 1;
            border-right: solid thin #e0e0e0;
            margin: .2em 0;
            padding: 0 .2em;
        }

        .cell input {
            text-align: right;
        }

        input.total {
            font-weight: 600;
        }

        header .cell {
            font-weight: 900;
        }

        header .year {
            text-align: center;
        }

        .masse .line:nth-child(even) {
            background: #efefef;
        }

        .line .cell-code { flex: 0 0 4em; }
        .line .cell.year { flex: 0 0 7em;}
        .line .cell.total { flex: 0 0 10em; text-align: right }

        .marge-2 .cell-label { padding-left: 1em }
        .marge-3 .cell-label { padding-left: 1.4em; font-size: .9em; font-weight: 400 }
        .marge-4 .cell-label { padding-left: 1.8em; font-size: .8em; font-weight: 200 }
        .marge-5 .cell-label { padding-left: 2.2em; font-size: .7em; font-weight: 100 }

        .marge-2 .cell-code { padding-left: 1em }
        .marge-3 .cell-code { padding-left: 1.4em; font-size: .9em; font-weight: 400 }
        .marge-4 .cell-code { padding-left: 1.8em; font-size: .8em; font-weight: 200 }
        .marge-5 .cell-code { padding-left: 2.2em; font-size: .7em; font-weight: 100 }

        .cell-code code { font-weight: 100}
    </style>
    <script>
        require(["vue", 'vue-resource'], function(Vue, VueResource){
            Vue.use(VueResource);
           new Vue({
               el: "#app",
               data: {
                   loadingMsg: "",
                   error: "",
                   masses: <?= json_encode($masses) ?>,
                   lines: <?= json_encode($lines) ?>,
                   years: <?= json_encode($years) ?>,
                   values: <?= json_encode($values) ?>,
                   totaux: {}
               },

               computed: {
                   byMasse(){
                       let out = [];
                       for( let masse in this.masses ){
                           let group = {
                               label: this.masses[masse],
                               code : masse,
                               comptes: []
                           };

                           for( compte in this.lines ){

                               let line = this.lines[compte]; // Données du compte
                               let code = line.code; // CODE du compte
                               let values = this.values[code]; // Valeurs pour le compte

                               // On filtre les comptes selon la MASSE
                               if( line.annexe == masse ){
                                   let compteObj = {
                                       code: line.code,
                                       label: line.label,
                                       years: []
                                   };

                                   for( let year in this.years ){
                                       let y = this.years[year];    // Année
                                       let value = values && values[y] ? values[y] : '0'; // Valeur pour cette année
                                       compteObj.years.push({
                                           label: y,
                                           value: value
                                       });
                                   }
                                   group.comptes.push(compteObj);
                               }
                           }
                           out.push(group);
                       }
                       return out;
                   }
               },

               methods: {
                   handlerSave(event){
                       console.log("Enregistrement...");
                       let formData = new FormData(event.target);
                       this.$http.post('', formData).then(
                           ok => {
                               console.error(ok);
                           },
                           ko => {
                               console.error(ko);
                               this.error = ko.body;
                           }
                       ).then( foo => {
                           this.loadingMsg = "";
                       });
                   },

                   handlerChange(evt, code, year){
                       console.log("UPDATE", code, year, evt.target.value);
                       var value = parseFloat(evt.target.value)?parseFloat(evt.target.value):0;
                       if( !this.values.hasOwnProperty(code) ){
                           this.values[code] = {};
                       }
                       this.values[code][year] = value;
                   },

                   total(code) {
                       console.log(code, this.values[code], this.values);
                       let total = 0.0;
                       if( this.values[code] ){
                           for( let i in this.values[code] ){
                               console.log(i);
                               total += parseFloat(this.values[code][i]);
                           }
                       }
                       return total;
                   }

               },

               created: function(){

                   console.log("Created", this.lines);
                   this.lines.forEach(line => {
                      this.totaux[line.code] = 0.0;
                   });
               }
           });
           document.querySelector('#app').style.display = 'block';
        });
    </script>

    <?php /*
    <div id="app">APP</div>
    <script>
        require(['vue', 'vue-resource', 'EstimatedSpentActivity', 'EstimatedSpentActivityItem'], function(Vue, VueResource,EstimatedSpentActivity, EstimatedSpentActivityItem){
            Vue.component('estimatedspentactivityitem', EstimatedSpentActivityItem.default);
            var v = new Vue({
                'render': function(h){
                    return h(EstimatedSpentActivity.default, { props: { years: <?= json_encode($years) ?>, types: <?= json_encode($types) ?>, values: <?= json_encode($values)?>}});
                }
            });

            v.$on('*', function(){
                console.log('bar !');
            });

            v.$mount('#app');

        })
    </script> */ ?>

</div>
