
<section class="container-fluid">
    <h1>Dépenses pour <strong><?= $activity->getCodeEOTP() ?></strong> (<?= $activity ?>)</h1>


    <div id="spentlines"></div>
    <script>
        require(['vue', 'vue-resource', 'SpentLinePFI'], function(Vue, VueResource, SpentLinePFI){
            console.log("DONE");
            Vue.use(VueResource);
            new Vue({
                el: "#spentlines",
                render(h){
                    return h(SpentLinePFI.default, { props: {
                            url: "<?= $this->url('spent/activity-api', ['id' => $activity->getId()]) ?>"
                        }});
                }

            });
        })
    </script>

    <?php if($msg): ?>
    <div class="alert alert-info"><?= $msg ?></div>
    <?php endif; ?>
    <?php if($error): ?>
        <div class="alert alert-danger"><?= $error ?></div>
    <?php endif; ?>




    <?php if( count($spents) ): ?>
    <table class="table table-condensed table-bordered table-condensed card">
        <thead>
            <tr>
                <th>N°</th>
                <th>Ligne(s)</th>
                <th>Description</th>
                <th>Montant</th>
                <th>Compte</th>
                <th>Date comptable</th>
                <th>Date paiement</th>
                <th>Année</th>
            </tr>
        </thead>
        <?php
        $total = 0.0;
        /** @var \Oscar\Entity\SpentLine $spentLine */
        foreach ($spents as $spentLine): ?>
            <tr>
                <td><?= $spentLine['refPiece'] ?></td>
                <td><?= count($spentLine['details']) ?></td>
                <td><?= implode(', ', $spentLine['text']) ?></td>
                <td><?= number_format($spentLine['montant'], 2) ?></td>
                <td><?= implode(', ', $spentLine['compteBudgetaire']) ?></td>
                <td><?= $spentLine['datecomptable'] ?></td>
                <td><?= $spentLine['datepaiement'] ?></td>
                <td><?= $spentLine['annee'] ?></td>
                <!-- <td><pre><?php var_dump($spentLine) ?></pre></td> -->
            </tr>

            <?php
            /** @var \Oscar\Entity\SpentLine $line */
            foreach ($spentLine['details'] as $line) :?>
            <tr class="text-small">
                <td>&nbsp;</td>
                <td><?= $line['syncid'] ?></td>
                <td><?= $line['texteFacture'] ?:$line['designation'] ?></td>
                <td><?= number_format($line['montant'], 2) ?></td>
                <td><?= $line['compteBudgetaire'] ?></td>
                <td><?= $line['dateComptable'] ?></td>
                <td><?= $line['datePaiement'] ?></td>
                <td><?= $line['dateAnneeExercice'] ?></td>
            </tr>
            <?php endforeach; ?>
            <?php $total += $spentLine['montant'] ?>
        <?php endforeach; ?>
        <tfoot>
            <tr>
                <td colspan="3">&nbsp;</td>
                <td><?= number_format($total,2) ?></td>
            </tr>
        </tfoot>
    </table>
    <?php else: ?>
        <form action="" method="post">
            <button type="submit" name="action" value="update">Synchroniser</button>
        </form>
    <?php endif; ?>

</section>