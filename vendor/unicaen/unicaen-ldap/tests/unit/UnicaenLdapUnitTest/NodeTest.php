<?php

namespace UnicaenLdapTest;

use PHPUnit_Framework_TestCase;
use Zend\ServiceManager\ServiceManager;
use UnicaenLdap\Ldap;
use UnicaenLdap\Node;

/**
 * @group Node
 */
class NodeTest extends PHPUnit_Framework_TestCase
{
    /**
     *
     * @var Ldap
     */
    protected $ldap;


    protected function setUp()
    {
        $this->ldap = $this->getMock('UnicaenLdap\Ldap', array('getBaseDn'));
        $this->ldap->expects($this->any())
                 ->method('getBaseDn')
                 ->will($this->returnValue('dc=unicaen,dc=fr'));
    }

    public function nodeProvider()
    {
        return array(
            array( 'uid=e20100360,ou=people,dc=unicaen,dc=fr', array ( 'cn' => array ( 0 => 'Pothier Kristell', ), 'createtimestamp' => array ( 0 => '20140117050016Z', ), 'creatorsname' => array ( 0 => 'cn=admin,dc=unicaen,dc=fr', ), 'datedenaissance' => array ( 0 => '19840130', ), 'datefininscription' => array ( 0 => '20141231', ), 'displayname' => array ( 0 => 'Kristell Pothier', ), 'edupersonaffiliation' => array ( 0 => 'student', 1 => 'researcher', 2 => 'member', ), 'edupersonorgdn' => array ( 0 => 'dc=unicaen,dc=fr', ), 'edupersonorgunitdn' => array ( 0 => 'supannCodeEntite=HS_M17,ou=structures,dc=unicaen,dc=fr', ), 'edupersonprimaryaffiliation' => array ( 0 => 'student', ), 'edupersonprimaryorgunitdn' => array ( 0 => 'supannCodeEntite=HS_M17,ou=structures,dc=unicaen,dc=fr', ), 'edupersonprincipalname' => array ( 0 => '20100360@unicaen.fr', ), 'entrycsn' => array ( 0 => '20140117050016.024935Z#000000#000#000000', ), 'entrydn' => array ( 0 => 'uid=e20100360,ou=people,dc=unicaen,dc=fr', ), 'entryuuid' => array ( 0 => 'ffc6ff64-137f-1033-8e23-a3b3f8edf74a', ), 'gidnumber' => array ( 0 => '10000', ), 'givenname' => array ( 0 => 'Kristell', ), 'hassubordinates' => array ( 0 => 'FALSE', ), 'homedirectory' => array ( 0 => '/home/etudiants/20100360', ), 'lmpassword' => array ( 0 => 'BD0ED2BDDB51D6DBAAD3B435B51404EE', ), 'loginshell' => array ( 0 => '/bin/bash', ), 'mail' => array ( 0 => '20100360@etu.unicaen.fr', ), 'modifiersname' => array ( 0 => 'cn=admin,dc=unicaen,dc=fr', ), 'modifytimestamp' => array ( 0 => '20140117050016Z', ), 'ntpassword' => array ( 0 => '2C35D0B32BB729D30AD758F1B6A0A0B1', ), 'objectclass' => array ( 0 => 'top', 1 => 'person', 2 => 'organizationalPerson', 3 => 'inetOrgPerson', 4 => 'eduPerson', 5 => 'supannPerson', 6 => 'ucbnEtu', 7 => 'posixAccount', 8 => 'sambaAccount', 9 => 'sambaSamAccount', ), 'preferredlanguage' => array ( 0 => 'fr', ), 'rescuepassword' => array ( 0 => '3xsycibxYrqursCYIQcCzQPOrkUztlSJ2q1d5pcpxuE=', ), 'rid' => array ( 0 => '20100360', ), 'sambalmpassword' => array ( 0 => 'BD0ED2BDDB51D6DBAAD3B435B51404EE', ), 'sambantpassword' => array ( 0 => '2C35D0B32BB729D30AD758F1B6A0A0B1', ), 'sambasid' => array ( 0 => 'S-1-S-21-xxxxx-20100360', ), 'sexe' => array ( 0 => 'F', ), 'sn' => array ( 0 => 'Pothier', ), 'structuralobjectclass' => array ( 0 => 'inetOrgPerson', ), 'subschemasubentry' => array ( 0 => 'cn=Subschema', ), 'supannaffectation' => array ( 0 => 'M17;UFR de Médecine', ), 'supannaliaslogin' => array ( 0 => '20100360', ), 'supannautremail' => array ( 0 => 'pothier.20100360@etu.unicaen.fr', ), 'supanncivilite' => array ( 0 => 'Mme', ), 'supanncodeine' => array ( 0 => '0594015503A', ), 'supannentiteaffectation' => array ( 0 => 'HS_M17', ), 'supannentiteaffectationprincipale' => array ( 0 => 'HS_M17', ), 'supannetablissement' => array ( 0 => '{UAI}0141408E', ), 'supannetuanneeinscription' => array ( 0 => '2013', ), 'supannetucursusannee' => array ( 0 => '{SUPANN}D', ), 'supannetudiplome' => array ( 0 => '{SISE}4200008', ), 'supannetuetape' => array ( 0 => '{UAI:0141408E}AE_TH5043-961', ), 'supannetuid' => array ( 0 => '20100360', ), 'supannetuinscription' => array ( 0 => '[etab={UAI}0141408E][anneeinsc=2013][regimeinsc={SISE}10][sectdisc={SISE}0006][typedip={SISE}YA][cursusann={SUPANN}D][affect=HS_M17][diplome={SISE}4200008][etape={UAI:0141408E}AE_TH5043-961]', ), 'supanneturegimeinscription' => array ( 0 => '{SISE}10', ), 'supannetusecteurdisciplinaire' => array ( 0 => '{SISE}0006', ), 'supannetutypediplome' => array ( 0 => '{SISE}YA', ), 'supannlisterouge' => array ( 0 => 'TRUE', ), 'supannparraindn' => array ( 0 => 'uid=apogee,ou=system,dc=unicaen,dc=fr', ), 'supanntypeentiteaffectation' => array ( 0 => '{SUPANN}S200', ), 'ucbnanneepostbac' => array ( 0 => '6', ), 'ucbncodeetape' => array ( 0 => 'TH5043;Doctorat: Recherche Clinique, Innovation Technologie,Santé', ), 'ucbnmonetupass' => array ( 0 => 'TRUE', ), 'ucbnprivateaddress' => array ( 0 => '17 QUAI EUGÈNE MESLIN$$$14000$CAEN$FRANCE', ), 'ucbnprivateaddressbis' => array ( 0 => 'LA COUR MOREAU$$$14950$BEAUMONT-EN-AUGE$FRANCE', ), 'ucbnprofildoccode' => array ( 0 => '9994', ), 'ucbnprofildoclib' => array ( 0 => 'Toutes disciplines', ), 'ucbnprofildocsecteurdisciplinaire' => array ( 0 => '0006', ), 'ucbnprofildocsite' => array ( 0 => '1', ), 'ucbnsecteurdisciplinaire' => array ( 0 => '0006;Sciences de la vie,biologie,santé', ), 'ucbnservicead' => array ( 0 => 'TRUE', ), 'ucbnserviceade' => array ( 0 => 'TRUE', ), 'ucbnserviceannuaire' => array ( 0 => 'TRUE', ), 'ucbnserviceespaceperso' => array ( 0 => 'TRUE', ), 'ucbnserviceimap' => array ( 0 => 'TRUE', ), 'ucbnserviceressourcesdoc' => array ( 0 => 'TRUE', ), 'ucbnservicewifi' => array ( 0 => 'TRUE', ), 'ucbnsitelocalisation' => array ( 0 => '18;CAMPUS 5 "SANTE"', ), 'ucbnstatus' => array ( 0 => 'ETUDIANT', ), 'uid' => array ( 0 => 'e20100360', ), 'uidnumber' => array ( 0 => '20100360', ), 'unixdespassword' => array ( 0 => 'zU91atyhSKSwI', ), 'unixmd5password' => array ( 0 => '$1$QBjWVelk$ICntKweXf4m1GZ8VRu1OU1', ), 'userpassword' => array ( 0 => '{SMD5}tC/DNo2rYnuOJFmTkCE9iClWPpI=', ), 'dn' => 'uid=e20100360,ou=people,dc=unicaen,dc=fr' ) ),
            array( 'uid=p00034360,ou=people,dc=unicaen,dc=fr', array ( 'cn' => array ( 0 => 'Raveleau Bruno', ), 'createtimestamp' => array ( 0 => '20140117050359Z', ), 'creatorsname' => array ( 0 => 'cn=admin,dc=unicaen,dc=fr', ), 'datedenaissance' => array ( 0 => '19750309', ), 'datefininscription' => array ( 0 => '20140408', ), 'displayname' => array ( 0 => 'Bruno Raveleau', ), 'edupersonaffiliation' => array ( 0 => 'affiliate', ), 'edupersonorgdn' => array ( 0 => 'dc=unicaen,dc=fr', ), 'edupersonorgunitdn' => array ( 0 => 'supannCodeEntite=HS_Y01,ou=structures,dc=unicaen,dc=fr', ), 'edupersonprimaryaffiliation' => array ( 0 => 'affiliate', ), 'edupersonprimaryorgunitdn' => array ( 0 => 'supannCodeEntite=HS_Y01,ou=structures,dc=unicaen,dc=fr', ), 'edupersonprincipalname' => array ( 0 => 'raveleau@unicaen.fr', ), 'entrycsn' => array ( 0 => '20140117050359.376264Z#000000#000#000000', ), 'entrydn' => array ( 0 => 'uid=p00034360,ou=people,dc=unicaen,dc=fr', ), 'entryuuid' => array ( 0 => '84e7b508-1380-1033-9c86-a3b3f8edf74a', ), 'gidnumber' => array ( 0 => '2001', ), 'givenname' => array ( 0 => 'Bruno', ), 'hassubordinates' => array ( 0 => 'FALSE', ), 'homedirectory' => array ( 0 => '/home/personnels/raveleau', ), 'lmpassword' => array ( 0 => '1CEC11213DBD2CA7C81667E9D738C5D9', ), 'loginshell' => array ( 0 => '/bin/bash', ), 'modifiersname' => array ( 0 => 'cn=admin,dc=unicaen,dc=fr', ), 'modifytimestamp' => array ( 0 => '20140117050359Z', ), 'ntpassword' => array ( 0 => 'E8ECD93A0D0E92FB2973852717981FE6', ), 'objectclass' => array ( 0 => 'top', 1 => 'inetOrgPerson', 2 => 'organizationalPerson', 3 => 'person', 4 => 'eduPerson', 5 => 'supannPerson', 6 => 'posixAccount', 7 => 'sambaAccount', 8 => 'sambaSamAccount', 9 => 'ucbnEmp', ), 'postaladdress' => array ( 0 => 'CAMPUS 2 - Bâtiment Sciences 3 Etage 3 - Porte 398$BVD Maréchal Juin$$14032$CAEN$FRANCE', ), 'preferredlanguage' => array ( 0 => 'fr', ), 'rescuepassword' => array ( 0 => 'lKymBFW4ewrFtrcqkgbExILNF9faMY2HLgIyKErRNt8=', ), 'rid' => array ( 0 => '36360', ), 'sambalmpassword' => array ( 0 => '1CEC11213DBD2CA7C81667E9D738C5D9', ), 'sambantpassword' => array ( 0 => 'E8ECD93A0D0E92FB2973852717981FE6', ), 'sambasid' => array ( 0 => 'S-1-S-21-xxxxx-36360', ), 'sexe' => array ( 0 => 'M', ), 'sn' => array ( 0 => 'Raveleau', ), 'structuralobjectclass' => array ( 0 => 'inetOrgPerson', ), 'subschemasubentry' => array ( 0 => 'cn=Subschema', ), 'supannaffectation' => array ( 0 => 'Y01;Centre Régional des Oeuvres Universitaires et Scolaires (CROUS)', ), 'supannaliaslogin' => array ( 0 => 'raveleau', ), 'supanncivilite' => array ( 0 => 'M.', ), 'supannempid' => array ( 0 => '00034360', ), 'supannentiteaffectation' => array ( 0 => 'HS_Y01', ), 'supannentiteaffectationprincipale' => array ( 0 => 'HS_Y01', ), 'supannetablissement' => array ( 0 => '{UAI}0141408E', ), 'supannlisterouge' => array ( 0 => 'TRUE', ), 'supannparraindn' => array ( 0 => 'uid=p00016779,ou=people,dc=unicaen,dc=fr', ), 'supanntypeentiteaffectation' => array ( 0 => '{SUPANN}S199', ), 'ucbnorganisme' => array ( 0 => 'P4;Convention/Associat.', ), 'ucbnprofildoccode' => array ( 0 => '9994', ), 'ucbnprofildoclib' => array ( 0 => 'Toutes disciplines', ), 'ucbnprofildocsite' => array ( 0 => '1', ), 'ucbnservicead' => array ( 0 => 'TRUE', ), 'ucbnserviceannuaire' => array ( 0 => 'TRUE', ), 'ucbnserviceespaceperso' => array ( 0 => 'TRUE', ), 'ucbnserviceressourcesdoc' => array ( 0 => 'TRUE', ), 'ucbnservicewifi' => array ( 0 => 'TRUE', ), 'ucbnsitelocalisation' => array ( 0 => '13;CAMPUS 2', ), 'ucbnsquidhash' => array ( 0 => 'Unicaen:a9951a9036dddb3f73314504378c1afc', ), 'ucbnstatus' => array ( 0 => 'HEBERGE', ), 'uid' => array ( 0 => 'p00034360', ), 'uidnumber' => array ( 0 => '36360', ), 'unixdespassword' => array ( 0 => '0R4PB9C6hI7lE', ), 'unixmd5password' => array ( 0 => '$1$kjYHee2A$VmeqMU1.n52/kCObmxLuC1', ), 'userpassword' => array ( 0 => '{SHA}tE65qT3wbxPtF0EWWt/dTKIGm0o=', ), 'dn' => 'uid=p00034360,ou=people,dc=unicaen,dc=fr' ) ),
        );
    }

    /**
     * @dataProvider nodeProvider
     * @param string $dn
     * @param array $data
     */
    public function testNode( $dn, array $data )
    {
        $node = Node::fromEntry($dn, $this->ldap, $data);

        $this->assertInstanceOf('UnicaenLdap\Node', $node);
        $this->assertTrue( $node->attributeHasValue('cn', $data['cn'][0]) );
        $this->assertEquals($data['datedenaissance'], $node->datedenaissance);
    }
}