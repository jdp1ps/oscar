<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>
  <style>
  body {
    font-family: Arial;
  }
    .stack {
      text-shadow: -1px 1px 0 #fff;
      background:  #eee;
      padding: 4px;
      margin: 1em;
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(0,0,0,.1);
      display: inline-block;
    }
    .stacker {
      font-weight: 600;}
      .stacker:after {
        content: ' : ';}
    .list-stacked { display: inline; margin: 0; padding: 0}
    .stacked {
      display: inline;
      margin: 0 0;
      padding: 4px;
      background: #ccc;
      border-radius: 4px;
      font-size: .9em;}
  </style>
  <strong onclick="view.changeStack('enrolled', 'role')">Par personne</strong> /
  <strong onclick="view.changeStack('role', 'enrolled')">Par rôle</strong> /
  <div id="roles">

  </div>
  <script type="template" id="tpl">
  <article class="stack">
    <span class="stacker">{{ label }}</span>
    <ul class="list-stacked">
      {{#each roles}}
      <li class="stacked">{{ label }}</li>
      {{/each}}
    </ul>
  </article>
  </script>
  <script src="js/vendor/jquery/dist/jquery.js"></script>
  <script src="js/vendor/underscore/underscore.js"></script>
  <script src="js/vendor/backbone/backbone.js"></script>
  <script src="js/vendor/handlebars/handlebars.js"></script>
  <script>
  //////////////////////////////////////////////////////////////////////////////
  // DONNEES de TEST

  var tpl = Handlebars.compile($('#tpl').text());

  var Enroll = Backbone.Model.extend({
    defaults: {
      id: 0,
      enrolledLabel: "",
      enrolled: 0,
      role: "",
      roleLabel: "",
      enrollerLabel: "",
      enroller: 0,
      start: null,
      end: null
    }
  });

  var EnrollCollection = Backbone.Collection.extend({
    model: Enroll
  });


  var EnrollView = Backbone.View.extend({
    render: function(){
      this.$el.html('M:' +
        this.model.get('enrolledLabel') +
        " - " +
        this.model.get('roleLabel')
      );
      return this;
    }
  });

  var EnrollCollectionView = Backbone.View.extend({

    aggregator: 'role',
    aggregateTo: 'enrolled',

      initialize: function(opt){
        console.log('initialize()');
        this.listenTo(this.collection, 'update', this.render);
      },

      changeStack: function (aggregator, aggregateTo){
        this.aggregator = aggregator;
        this.aggregateTo = aggregateTo;
        this.render();
      },

      render: function(){
        console.log('render()');
        this.$el.empty();
        var aggregat = {};
        var objIdUsed = [];

        this.collection.forEach(function(e){

          var idAggregat = e.get(this.aggregator);
          if( !aggregat[idAggregat] ){
            objIdUsed[idAggregat] = [];
            aggregat[idAggregat] = {
              label: e.get(this.aggregator+"Label"),
              roles: []
            };
          }
          if( objIdUsed[idAggregat].indexOf(e.get(this.aggregateTo)) < 0 ) {
            aggregat[idAggregat].roles.push({
              label: e.get(this.aggregateTo + 'Label'),
              id: e.get('id'),
              urlRemove: "todo?",
              objId: e.get(this.aggregateTo),
              objLabel: e.get(this.aggregateTo + "Label")
            });
            objIdUsed[idAggregat].push(e.get(this.aggregateTo));
          }
        }.bind(this));

        _.each(aggregat, function(stack){
          console.log(stack);
          this.$el.append(tpl(stack));
        }.bind(this));

        return this;
      }
  });

  var donnees = [
    {
      id: 53,
      enrolledLabel: "Jean-Claude DUS",
      enrolled: 7,
      role: "Administrateur",
      roleLabel: "Administrateur",
      enrollerLabel: "Activité A",
      enroller: 5,
      start: "2005-01-20",
      end: "2006-12-31"
    },
    {
      id: 54,
      enrolledLabel: "Jean-Claude DUS",
      enrolled: 7,
      role: "Responsable RH",
      roleLabel: "Responsable RH",
      enrollerLabel: "Activité A",
      enroller: 5,
      start: "2005-01-20",
      end: "2006-12-31"
    },
    {
      id: 55,
      enrolledLabel: "Robert BIDOCHON",
      enrolled: 8,
      role: "Ingénieur",
      roleLabel: "Ingénieur",
      enrollerLabel: "Activité A",
      enroller: 5,
      start: "2005-01-20",
      end: "2006-12-31"
    },

    {
      id: 56,
      enrolledLabel: "Dany BRILLANT",
      enrolled: 9,
      role: "Responsable RH",
      roleLabel: "Responsable RH",
      enrollerLabel: "Activité A",
      enroller: 5,
      start: "2005-01-20",
      end: "2006-12-31"
    }
  ];

  var roles = new EnrollCollection();
  roles.on('all', function(evt){
    console.log(evt, arguments);
  });

  var view = new EnrollCollectionView({
    el: "#roles",
    collection: roles
  });

  $.getJSON('http://127.0.0.1:4000/activites-de-recherche/persons/7217', function(data){
    roles.add(data);
  });
  // roles.add(donnees);
  </script>
</body>
</html>
