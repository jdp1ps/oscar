import{a as b,r as v,c as i,b as e,w as m,l as D,d as r,t as d,e as u,k as L,i as w,v as E,F as h,f as y,g as f,x as k,o as s,n as g}from"./vendor.js";import{O as S}from"./vendor7.js";import{P,D as x}from"./vendor3.js";import{_ as V}from"./vendor4.js";const I={components:{organizationselector:S,personselector:P,datepicker:x},props:{url:{required:!0},title:{required:!0}},data(){return{selectedPerson:null,selected:null,entities:[],entityEdited:null,entityDelete:null,entityNew:null,error:null,loading:!1,editMode:!1,urlNew:"",manage:!1,roles:[]}},computed:{sortedFull(){return this.entities.sort((o,t)=>o.enrolled-t.enrolled)},stacked(){let o={};return this.entities.forEach(t=>{let a=t.enrolled;o.hasOwnProperty(a)||(o[a]={enrolled:t.enrolled,urlShow:t.urlShow,enrolledLabel:t.enrolledLabel,hasPrimary:!1},o[a].roles={}),o[a].roles[t.roleId]={role:t.roleLabel,roleId:t.roleId,rolePrincipal:t.rolePrincipal,context:t.context},t.rolePrincipal&&(o[a].hasPrimary=!0)}),o}},methods:{handlerEdit(o){this.entityEdited=o},handlerDelete(o){this.entityDelete=o},handlerNew(){this.entityNew={end:"",start:"",role:null,enroled:null,enroledLabel:""}},handlerEnrolledSelected(o){this.entityNew.enroled=o.id,this.entityNew.enroledLabel=o.label},handlerEnrolledSelectedPerson(o){this.selected=o.id,this.entityNew.enroled=o.id,this.entityNew.enroledLabel=o.label},handlerCancel(){this.entityNew.enroled=null,this.entityNew.enroledLabel="",this.entityNew.role=null},open(o){document.location=o},handlerEditEnable(){this.editMode=!this.editMode},performDelete(){this.loading="Suppression...";var o=this.entityDelete.urlDelete;this.entityDelete=null,b.post(o,{}).then(t=>{},t=>{this.error=t.body}).then(t=>{this.loading=!1,this.fetch()})},performEdit(){this.loading="Enregistrement des modifications";let o=new FormData;o.append("dateStart",this.entityEdited.start),o.append("dateEnd",this.entityEdited.end),o.append("role",this.entityEdited.roleId),o.append("enrolled",this.entityEdited.enrolled);var t=this.entityEdited.urlEdit;return this.entityEdited=null,b.post(t,o).then(a=>{},a=>{this.error="Erreur : Impossible de modifier le rôle : "+a.body}).then(a=>{this.loading=!1,this.fetch()}),!1},performNew(){let o=new FormData;this.loading="Création...";var t=this.entityNew.enroled;o.append("dateStart",this.entityNew.start),o.append("dateEnd",this.entityNew.end),o.append("role",this.entityNew.role),o.append("enroled",t),this.entityNew=null,b.post(this.urlNew+"/"+t,o).then(a=>{},a=>{this.error=a.status==403?"Vous n'êtes pas authorisé à faire ça":"Erreur : "+a.body}).then(a=>{this.loading=!1,this.fetch()})},fetch(){console.log("FETCH",this.url),this.loading="Chargement...",b.get(this.url).then(o=>{console.log("LOADED",o),o.data.roles&&(this.roles=o.data.roles),o.data.manage&&(this.manage=o.data.manage),o.data.urlNew&&(console.log("urlnew:",o.data.urlNew),this.urlNew=o.data.urlNew),o.data.persons?this.entities=o.data.persons:o.data.organizations?this.entities=o.data.organizations:this.entities=o.data,this.loading=!1},o=>{this.error="Erreur : "+o.body})}},mounted(){console.log("MOUNTED"),this.fetch()}},M={class:"oscar-ajax"},U={class:"oscar-ajax-content"},z={key:0,class:"loading-message"},A=e("i",{class:"icon-spinner animate-spin animate"},null,-1),F={key:1,class:"error-message"},O=e("i",{class:"icon-attention-1"},null,-1),B={key:0,class:"overlay"},R={class:"overlay-content"},T={class:"admin-bar"},q=e("i",{class:"icon-angle-left"},null,-1),j=e("i",{class:"icon-trash"},null,-1),K={key:1,class:"overlay"},H={class:"overlay-content"},W={class:"admin-bar"},G=e("i",{class:"icon-angle-left"},null,-1),J={key:2,class:"overlay"},Q={class:"overlay-content",style:{overflow:"visible"}},X=["action"],Y={key:0},Z={class:"row"},$={class:"col-md-6"},ee={class:"form-group"},te=e("label",{class:"control-label",for:"role"},"Rôle",-1),le=["value"],ne={class:"col-md-6"},oe={class:"form-group"},se=e("label",{class:"form-label control-label",for:"dateStart"},"Date de début",-1),ie={class:"form-group"},re=e("label",{class:"form-label control-label",for:"dateEnd"},"Date de fin",-1),de={class:"admin-bar"},ae=e("i",{class:"icon-angle-left"},null,-1),ce=e("button",{class:"btn btn-primary",type:"submit"},[e("i",{class:"icon-floppy"}),r(" Enregistrer ")],-1),ue={key:3,class:"overlay"},me={class:"overlay-content",style:{overflow:"visible"}},he={class:"row"},ye={class:"col-md-6"},pe={key:0,class:"cartouche"},_e={key:0,class:"addon"},be={key:1,class:"form-group"},fe={class:"control-label",for:"enroled"},ve={class:"form-group"},ge=e("label",{class:"control-label",for:"role"},"Rôle",-1),we=["value"],Ee={class:"col-md-6"},ke={class:"form-group"},Ne=e("label",{class:"form-label control-label",for:"dateStart"},"Date de début",-1),Ce={class:"form-group"},De=e("label",{class:"form-label control-label",for:"dateEnd"},"Date de fin",-1),Le={class:"admin-bar"},Se=e("i",{class:"icon-angle-left"},null,-1),Pe=e("i",{class:"icon-floppy"},null,-1),xe={key:4,class:"admin-bar text-right"},Ve=e("i",{class:"icon-doc-add"},null,-1),Ie=e("i",{class:"icon-edit"},null,-1),Me={key:5},Ue=e("div",{class:"alert alert-info"}," Détails des affectations. Une personne peut apparaître plusieurs fois selon le contexte et le rôle ",-1),ze={class:"row card"},Ae={class:"col-md-6"},Fe={key:0,class:"icon-cube"},Oe={key:1,class:"icon-cubes"},Be={key:0},Re=e("i",{class:"icon-cube"},null,-1),Te={key:1},qe=e("i",{class:"icon-cubes"},null,-1),je={class:"col-md-3"},Ke={class:"col-md-3 text-right"},He=["onClick"],We={key:0,class:"icon-pencil-1 icon-clickable"},Ge=["onClick"],Je={key:0,class:"icon-trash icon-clickable"},Qe={key:6},Xe=["href"],Ye={key:1},Ze={class:"addon principal"};function $e(o,t,a,et,n,c){const p=v("datepicker"),N=v("personselector"),C=v("organizationselector");return s(),i("div",null,[e("template",null,[m(e("div",M,[e("div",U,[n.loading?(s(),i("div",z,[A,r(" "+d(n.loading),1)])):u("",!0),n.error?(s(),i("div",F,[e("span",{onClick:t[0]||(t[0]=l=>n.error=!1),style:{"font-weight":"bold",position:"absolute",top:"1em",right:"1em"}},"x"),O,r(),e("strong",null,d(n.error),1)])):u("",!0)])],512),[[D,n.loading||n.error]])]),n.entityDelete?(s(),i("div",B,[e("div",R,[e("i",{class:"icon-cancel-outline overlay-closer",onClick:t[1]||(t[1]=l=>n.entityDelete=null)}),e("h2",null,[r("Supprimer le rôle "),e("strong",null,d(n.entityDelete.role),1),r(" de "),e("strong",null,d(n.entityDelete.enrolledLabel),1),r(" ?")]),e("nav",T,[e("button",{class:"btn btn-default button-back",onClick:t[2]||(t[2]=l=>n.entityDelete=null)},[q,r(" Annuler ")]),e("button",{class:"btn btn-primary",onClick:t[3]||(t[3]=(...l)=>c.performDelete&&c.performDelete(...l))},[j,r(" Confirmer la suppression ")])])])])):u("",!0),n.error?(s(),i("div",K,[e("div",H,[e("i",{class:"icon-cancel-outline overlay-closer",onClick:t[4]||(t[4]=l=>n.error="")}),e("h2",null,[r("Erreur : "),e("strong",null,d(n.error),1)]),e("nav",W,[e("button",{class:"btn btn-default button-back",onClick:t[5]||(t[5]=l=>n.error="")},[G,r(" Annuler ")])])])])):u("",!0),n.entityEdited?(s(),i("div",J,[e("div",Q,[e("i",{class:"icon-cancel-outline overlay-closer",onClick:t[6]||(t[6]=l=>n.entityEdited=null)}),e("form",{action:n.entityEdited.urlEdit,method:"post",onSubmit:t[12]||(t[12]=L((...l)=>c.performEdit&&c.performEdit(...l),["prevent","stop"]))},[e("h2",null,[n.entityEdited.enrolledLabel?(s(),i("span",Y,[r(" Modifier "),e("strong",null,d(n.entityEdited.enrolledLabel),1),r(" en tant que "),e("em",null,d(n.entityEdited.role),1)])):u("",!0)]),m(e("input",{type:"hidden",name:"enroled",class:"form-control select2","onUpdate:modelValue":t[7]||(t[7]=l=>n.entityEdited.enrolled=l)},null,512),[[w,n.entityEdited.enrolled]]),e("div",Z,[e("div",$,[e("div",ee,[te,m(e("select",{name:"role",class:"form-control","onUpdate:modelValue":t[8]||(t[8]=l=>n.entityEdited.roleId=l)},[(s(!0),i(h,null,y(n.roles,l=>(s(),i("option",{value:l.id},d(l.label),9,le))),256))],512),[[E,n.entityEdited.roleId]])])]),e("div",ne,[e("div",oe,[se,f(p,{moment:o.moment,value:n.entityEdited.start,onInput:t[9]||(t[9]=l=>{n.entityEdited.start=l})},null,8,["moment","value"])]),e("div",ie,[re,f(p,{moment:o.moment,value:n.entityEdited.end,onInput:t[10]||(t[10]=l=>{n.entityEdited.end=l})},null,8,["moment","value"])])])]),e("nav",de,[e("button",{class:"btn btn-default button-back",onClick:t[11]||(t[11]=l=>n.entityEdited=null)},[ae,r(" Annuler ")]),ce])],40,X)])])):u("",!0),n.entityNew?(s(),i("div",ue,[e("div",me,[e("i",{class:"icon-cancel-outline overlay-closer",onClick:t[13]||(t[13]=l=>n.entityNew=null)}),e("h2",null,[r("Rôle de "),e("strong",null,d(n.entityNew.enroledLabel),1),r(" : ")]),m(e("input",{type:"hidden",name:"enroled",class:"form-control select2","onUpdate:modelValue":t[14]||(t[14]=l=>n.entityNew.enrolled=l)},null,512),[[w,n.entityNew.enrolled]]),e("div",he,[e("div",ye,[n.entityNew.enroledLabel?(s(),i("span",pe,[r(d(n.entityNew.enroledLabel)+" ",1),e("i",{class:"icon-cancel-alt icon-clickable",onClick:t[15]||(t[15]=(...l)=>c.handlerCancel&&c.handlerCancel(...l))}),n.entityNew.role?(s(),i("span",_e,d(n.roles[n.entityNew.role]),1)):u("",!0)])):(s(),i("div",be,[e("label",fe,d(a.title),1),a.title=="Personne"?(s(),k(N,{key:0,onChange:t[16]||(t[16]=l=>c.handlerEnrolledSelectedPerson(l)),modelValue:n.selected,"onUpdate:modelValue":t[17]||(t[17]=l=>n.selected=l)},null,8,["modelValue"])):(s(),k(C,{key:1,onChange:t[18]||(t[18]=l=>c.handlerEnrolledSelected(l)),modelValue:n.selected,"onUpdate:modelValue":t[19]||(t[19]=l=>n.selected=l)},null,8,["modelValue"]))])),e("div",ve,[ge,m(e("select",{name:"role",class:"form-control","onUpdate:modelValue":t[20]||(t[20]=l=>n.entityNew.role=l)},[(s(!0),i(h,null,y(n.roles,l=>(s(),i("option",{value:l.id},d(l.label),9,we))),256))],512),[[E,n.entityNew.role]])])]),e("div",Ee,[e("div",ke,[Ne,f(p,{moment:o.moment,value:n.entityNew.start,onInput:t[21]||(t[21]=l=>{n.entityNew.start=l})},null,8,["moment","value"])]),e("div",Ce,[De,f(p,{moment:o.moment,value:n.entityNew.end,onInput:t[22]||(t[22]=l=>{n.entityNew.end=l})},null,8,["moment","value"])])])]),e("nav",Le,[e("button",{class:"btn btn-default button-back",type:"button",onClick:t[23]||(t[23]=l=>n.entityNew=null)},[Se,r(" Annuler ")]),e("button",{class:"btn btn-primary",type:"button",onClick:t[24]||(t[24]=(...l)=>c.performNew&&c.performNew(...l))},[Pe,r(" Enregistrer ")])])])])):u("",!0),n.manage?(s(),i("nav",xe,[e("a",{class:"oscar-link",onClick:t[25]||(t[25]=l=>c.handlerNew())},[Ve,r(" Nouveau ")]),e("a",{class:"oscar-link",onClick:t[26]||(t[26]=l=>c.handlerEditEnable())},[Ie,r(" Modifier ")])])):u("",!0),n.editMode?(s(),i("section",Me,[Ue,(s(!0),i(h,null,y(c.sortedFull,l=>(s(),i("article",ze,[e("div",Ae,[l.context=="activity"?(s(),i("i",Fe)):(s(),i("i",Oe)),e("strong",null,d(l.enrolledLabel),1),e("small",null,[r(" ("),l.context=="activity"?(s(),i("span",Be,[Re,r(" "+d(l.contextKey),1)])):(s(),i("span",Te,[qe,r(" "+d(l.contextKey),1)])),r(") ")])]),e("div",je,[e("em",{class:g({bold:l.rolePrincipal})},d(l.roleLabel),3)]),e("div",Ke,[e("a",{onClick:_=>c.handlerEdit(l),style:{"white-space":"nowrap"}},[n.manage?(s(),i("i",We)):u("",!0),r(" Modifier ")],8,He),e("a",{onClick:_=>c.handlerDelete(l),style:{"white-space":"nowrap"}},[n.manage?(s(),i("i",Je)):u("",!0),r(" Supprimer ")],8,Ge)])]))),256))])):(s(),i("section",Qe,[(s(!0),i(h,null,y(c.stacked,l=>(s(),i("span",{class:g(["cartouche",{primary:l.hasPrimary,default:!l.hasPrimary}])},[l.urlShow?(s(),i("a",{key:0,href:l.urlShow},d(l.enrolledLabel),9,Xe)):(s(),i("span",Ye,d(l.enrolledLabel),1)),e("span",Ze,[(s(!0),i(h,null,y(l.roles,_=>(s(),i("span",{class:g(["addon-module",{primary:_.rolePrincipal}])},d(_.role),3))),256))])],2))),256))]))])}const st=V(I,[["render",$e]]);export{st as E};
