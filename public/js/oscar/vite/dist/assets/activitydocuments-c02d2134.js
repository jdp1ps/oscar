import{a as g,h as N,r as S,c as l,b as e,d as m,t as a,e as p,F as _,f as D,g as y,w as v,v as T,i as V,j as U,k as C,n as k,l as I,o as i,p as E,m as O,q as M}from"../vendor.js";import{D as W,m as P,f as A}from"../vendor2.js";import{D as z,P as q}from"../vendor3.js";import{_ as j}from"../vendor4.js";const B="private",R={components:{"document-list":W,"date-picker":z,"person-auto-completer":q},props:{urlUploadNewDoc:{required:!0},urlSignDocument:{required:!1},url:{required:!0}},data(){return{idCurrentPerson:null,persons:[],computedDocuments:[],dateDeposit:"",dateSend:"",fileUrl:"",fileUrlLabel:"",privateDocument:!1,selectedIdTypeDocument:null,selectedIdTabDocument:null,informationsDocument:"",fileToDownload:null,uploadNewDocData:{dateDeposit:this.dateDeposit,dateSend:this.dateSend,private:this.privateDocument,type:this.selectedIdTypeDocument,tab:this.selectedIdTabDocument,informations:this.informationsDocument,persons:this.persons,baseUrlUpload:this.urlUploadNewDoc,url:"",init:!1},errorMessages:[],tabId:null,tabsWithDocuments:null,formData:null,error:null,deleteData:null,editData:null,uploadDoc:null,documents:[],loading:!0,sortField:"dateUpload",sortDirection:-1,editable:!0,remoterState:null,displayComputed:!1,signDocument:null,signProcess:null,selectedSignProcess:null,signProcessError:"",editedDocument:null,mode:null,processDetails:null,mode_url:!1,typesDocuments:[],selectedTab:null,selectedTabId:null}},computed:{currentFlow(){if(this.editedDocument.category.id){let t=this.typesDocuments.find(n=>n.id==this.editedDocument.category.id);if(t.flow)return t.flow.signatureflow}return!1},selectedTypeDocument(){return this.selectedIdTypeDocument?this.typesDocuments.find(t=>t.id==this.selectedIdTypeDocument):null},documentsPacked(){let t=[];return this.documents&&(t=this.documents.sort(function(r,u){return r[this.sortField]<u[this.sortField]?-1*this.sortDirection:r[this.sortField]>u[this.sortField]?1*this.sortDirection:0}.bind(this))),t},packedDocuments(){let t={};if(this.tabsWithDocuments)for(const[n,r]of Object.entries(this.tabsWithDocuments)){let u={};for(const[s,d]of Object.entries(r.documents)){let f=d.fileName;u.hasOwnProperty(f)?u[f].versions.push(d):(d.versions=[],u[f]=d)}t[n]={id:r.id,label:r.label,total:r.total,description:r.description,manage:r.manage,roles:r.roles,documents:u}}return t}},methods:{handlerPerformSignDocumentDisabled(t,n){if(!n||n.missing_recipients)return!0;for(let r=0;r<n.steps.length;r++){let u=n.steps[r],s=u.editable,d=0;for(let f=0;f<u.recipients.length;f++){let b=u.recipients[f];s?b.selected==!0&&d++:d++}if(d==0)return this.signProcessError="L'étape "+u.order+' "'+u.label+`" n'a pas de destinataire.`,!0}return this.signProcessError="",!1},handlerSelectProcess(t){this.signProcessError="",this.selectedSignProcess=t},handlerPerformSignDocument(t,n){let r=new FormData,u=this.urlSignDocument;return r.append("document_id",t.id),r.append("flow_datas",JSON.stringify(n)),g.post(u,r).then(s=>{this.signDocument=null,this.selectedSignProcess=null,this.fetch()},s=>{this.error=s.response.data?s.response.data:s.message}),!1},renderDate(t){return t?N(t).fromNow():"non précisé"},handlerProcessDetailsOn(t){this.processDetails=t},handlerProcessDetailsOff(){this.processDetails=null},activeTab(t){this.tabId=t},deleteDocument(t){this.deleteData=t},handlerSignDocument(t){this.signDocument=t},order:function(t){this.sortField==t?this.sortDirection*=-1:this.sortField=t},cssStepCurrent(t){return t===this.tabId?"current":""},cssSort:function(t){return t===this.sortField?"active":""},handlerEdit(t){this.editedDocument=t,this.mode="edit"},handlerSelectPersons(t){if(t.id){let n={personName:t.displayname,personId:t.id,affectation:t.affectation},r=t.id,u=!1;this.persons.forEach(function(s){s.personId===r&&(u=!0)}),u===!1&&(this.editedDocument?(this.editedDocument.persons||(this.editedDocument.persons=[]),this.editedDocument.persons.push(n)):this.persons.push(n))}},handlerDeletePerson(t){this.persons.splice(this.persons.indexOf(t),1)},handlerNew(t){this.mode="new",this.editedDocument={id:-1,version:1,information:"",fileName:"",process:!1,process_sendable:null,fileSize:0,typeMime:null,dateUpload:null,dateDeposit:null,dateSend:null,extension:null,category:{id:null},tabDocument:this.getTabById(t),private:!1,persons:[],location:"local",urlDelete:"",urlDownload:"",urlReupload:"",uploader:null,urlPerson:!1}},handlerNewVersion(t){this.mode="version",this.editedDocument=t},uploadFile(t){t.target.files.length!==0&&(this.fileToDownload=t.target.files[0])},handlerProcessReload(t){let n=new FormData;g.post(t.manage_process,n).then(r=>{this.fetch()},r=>{this.error=r.response&&r.response.data?r.response.data:r})},applyEdit(){let t=new FormData,n="";if(t.append("data",JSON.stringify(this.editedDocument)),this.mode==="version"?(t.append("action","version"),n=this.editedDocument.urlReupload):this.mode==="new"?(t.append("action","new"),t.append("flow",""),n=this.urlUploadNewDoc):this.mode==="edit"&&(t.append("action","edit"),n=this.editedDocument.urlReupload),this.mode!=="edit")if(this.fileToDownload!==null)t.append("file",this.fileToDownload,this.fileToDownload.name);else{this.error="Aucun fichier sélectionner a téléverser !";return}g.post(n,t).then(r=>{this.editedDocument=null,this.fetch()},r=>{this.error=r.response&&r.response.data?r.response.data:r})},performEdit(){this.errorMessages=[];let t=[],n="",r=!0;if(this.editData.private===!0?(r=1,this.persons.length!==0&&this.persons.forEach(f=>{t.push(f.personId)})):(r=0,this.editData.tabDocument_id===B||this.editData.tabDocument_id===""?this.errorMessages.push("Vous devez sélectionner un onglet pour la modification (ce n'est pas un document qualifié privé)"):n=this.editData.tabDocument_id),this.errorMessages.length!==0)return;let u=this.editData.document.id,s=this.editData.documentype_id;this.editData=null,this.persons=[];let d=new FormData;d.append("documentId",u),d.append("type",s),d.append("tabDocument",n),d.append("private",r),d.append("persons",t)},getTabById(t){let n=this.tabsWithDocuments[t];return{id:n.id,label:n.label}},handlerSuccess(t){try{if(!t.data)throw"Impossible de charger les documents, vérifiez que vous êtes toujours connecté";this.idCurrentPerson=t.data.idCurrentPerson;let n=Array.isArray(t.data.tabsWithDocuments)?{}:t.data.tabsWithDocuments,r=null,u=null;if(n)if(Object.keys(n).forEach(s=>{let d=n[s];d.total=d.documents.length,d.documents.sort((f,b)=>b.version-f.version),d.documents.forEach(f=>{f.explode=!0}),r==null&&(r=d.id),u==null&&d.documents.length>0&&(u=d.id)}),this.tabsWithDocuments=n,this.computedDocuments=t.data.computedDocuments,this.signProcess=t.data.process_datas,this.typesDocuments=t.data.typesDocuments,this.selectedTabId==null&&(this.selectedTabId=u||r),this.tabsWithDocuments.unclassified&&this.tabsWithDocuments.unclassified.documents.length)this.selectedTab=this.tabsWithDocuments.unclassified;else{let s=Object.keys(this.tabsWithDocuments)[0];s.length&&(this.selectedTab=this.tabsWithDocuments[s[0]])}else throw new Error("Vous n'avez pas accès aux documents")}catch(n){this.error=n}},handlerSelectTab(t){t=="computed"?(this.displayComputed=!0,this.selectedTab=null,this.selectedTabId=null):(this.displayComputed=!1,this.selectedTab=t,this.selectedTabId=t.id)},fetch(){g.get(this.url).then(t=>{this.handlerSuccess(t)},t=>{this.error=t.response.data?t.response.data:t})}},mounted(){this.fetch()}},c=t=>(E("data-v-504e3cfe"),t=t(),O(),t),X={key:0,class:"overlay",style:{"z-index":"101"}},L={class:"overlay-content",style:{"max-width":"50%"}},J={class:"alert-danger alert"},K=c(()=>e("i",{class:"icon-attention-1"},null,-1)),G=c(()=>e("i",{class:"icon-cancel-outline"},null,-1)),H={key:1,class:"overlay"},Q={class:"overlay-content",style:{"max-width":"50%"}},Y=c(()=>e("small",null,[e("i",{class:"icon-edit"}),m(" Procédure")],-1)),Z=c(()=>e("br",null,null,-1)),$=c(()=>e("br",null,null,-1)),ee={class:"signature-status-101"},te={class:"status"},se={class:"metas"},ne={class:"meta"},oe={class:"meta"},le={class:"fullname"},ie={class:"email"},re={class:"status"},de={class:"status-text"},ae=c(()=>e("strong",null,"Observateurs : ",-1)),ce={class:"buttons-bar"},ue=c(()=>e("i",{class:"icon-cancel-outline"},null,-1)),me={style:{position:"relative","min-height":"100px"}},he={key:0,class:"overlay"},pe={class:"overlay-content"},fe={class:"alert-danger alert"},_e=c(()=>e("i",{class:"icon-attention-1"},null,-1)),De=c(()=>e("i",{class:"icon-cancel-alt"},null,-1)),ve=["href"],be=c(()=>e("i",{class:"icon-valid"},null,-1)),ge={key:1,class:"overlay"},ye={class:"overlay-content"},ke=c(()=>e("i",{class:"icon-doc"},null,-1)),we={key:0},Se={key:1},Te={key:2},Ce=c(()=>e("br",null,null,-1)),Pe={key:0},Ie={key:1},Fe={class:"row"},xe={class:"col-md-6"},Ne={key:0},Ve=c(()=>e("label",{for:"file"},"Fichier",-1)),Ue=c(()=>e("label",{for:"dateDeposit"},"Date de dépôt",-1)),Ee=c(()=>e("label",{for:"dateSend"},"Date d'envoi",-1)),Oe={class:"col-md-6"},Me={key:0},We=c(()=>e("label",{for:"tabdocument"},"Onglet",-1)),Ae=["value"],ze={key:1},qe=c(()=>e("label",{for:"typedocument"},"Type de document",-1)),je={key:0,class:"alert alert-warning"},Be={key:1},Re=["value","disabled"],Xe={class:"col-md-12"},Le=c(()=>e("label",{for:"information"},"Informations",-1)),Je={key:0,class:"col-md-6"},Ke={class:"row"},Ge={key:0},He=c(()=>e("label",{for:"tabdocument"},"Onglet document",-1)),Qe=["value"],Ye=c(()=>e("div",{class:"col-md-6"},[e("label",{for:"private"},"Document privé")],-1)),Ze={class:"col-md-6"},$e={key:0},et=c(()=>e("label",null,"Choix des personnes ayant accès à ce document",-1)),tt=c(()=>e("h3",null,"Ce document sera classé automatiquement dans l'onglet privé",-1)),st=c(()=>e("i",{class:"icon-cube"},null,-1)),nt={class:"addon"},ot=["onClick"],lt={class:"row"},it={class:"col-md-12"},rt={class:"buttons-bar"},dt=c(()=>e("i",{class:"icon-cancel-alt"},null,-1)),at=c(()=>e("i",{class:"icon-valid"},null,-1)),ct={key:2,class:"overlay"},ut={class:"overlay-content"},mt=c(()=>e("i",{class:"icon-cancel-alt"},null,-1)),ht={class:"documents-content"},pt={class:"tabs"},ft=["onClick"],_t={class:"label label-default"},Dt={class:"tab-content"},vt={class:""},bt=c(()=>e("i",{class:"picto icon-doc"},null,-1)),gt=c(()=>e("small",{class:"text-light"},"  (Document généré automatiquement) ",-1)),yt={class:"text-right show-over"},kt=["href"],wt=c(()=>e("i",{class:"icon-upload-outline"},null,-1)),St={class:"tab-content"},Tt={key:0,class:"text-right"},Ct=["onClick"],Pt=c(()=>e("i",{class:"icon-download"},null,-1));function It(t,n,r,u,s,d){const f=S("date-picker"),b=S("person-auto-completer"),x=S("document-list");return i(),l(_,null,[s.error?(i(),l("div",X,[e("div",L,[e("h2",null,[m(" Erreur documents "),e("span",{class:"overlay-closer",onClick:n[0]||(n[0]=o=>s.error=null)},"X")]),e("p",J,[K,m(a(s.error),1)]),e("button",{class:"btn btn-default",onClick:n[1]||(n[1]=o=>s.error=null)},[G,m(" Fermer ")])])])):p("",!0),s.processDetails?(i(),l("div",H,[e("div",Q,[e("h2",null,[Y,m(),Z,e("strong",null,a(s.processDetails.label),1),m(),$,e("span",ee,[m(a(s.processDetails.status_text)+" - ",1),e("em",null,"étape "+a(s.processDetails.current_step)+" / "+a(s.processDetails.total_steps),1)]),e("span",{class:"overlay-closer",onClick:n[2]||(n[2]=(...o)=>d.handlerProcessDetailsOff&&d.handlerProcessDetailsOff(...o))},"X")]),(i(!0),l(_,null,D(s.processDetails.steps,o=>(i(),l("section",{class:k(["signature","signature-status-"+o.status])},[e("h4",null,[e("small",null,"Étape "+a(o.order)+" : ",1),e("strong",null,a(o.label),1),e("span",te," ("+a(o.status_text)+")",1)]),e("ul",se,[e("li",ne,[m("Parapheur "),e("strong",null,a(o.letterfile),1)]),e("li",oe,[m("Niveau "),e("strong",null,a(o.level),1)])]),(i(!0),l(_,null,D(o.recipients,h=>(i(),l("article",{class:k(["recipient","signature-status-"+h.status])},[e("strong",le,a(h.fullname),1),e("em",ie,a(h.email),1),e("small",null,a(t.$filters.dateFull(h.dateFinished)),1),e("span",re,[e("span",de,a(h.status_text),1)])],2))),256)),ae,(i(!0),l(_,null,D(o.observers,h=>(i(),l("span",null,[e("small",null,a(h.firstname),1),m(),e("span",null,a(h.lastname),1)]))),256))],2))),256)),e("div",ce,[e("button",{class:"btn btn-default",onClick:n[3]||(n[3]=(...o)=>d.handlerProcessDetailsOff&&d.handlerProcessDetailsOff(...o))},[ue,m(" Fermer ")])])])])):p("",!0),e("section",me,[s.deleteData?(i(),l("div",he,[e("div",pe,[e("h2",null,[m(" Suppression du fichier ? "),e("span",{class:"overlay-closer",onClick:n[4]||(n[4]=o=>s.deleteData=null)},"X")]),e("p",fe,[_e,m(" Souhaitez-vous supprimer le fichier "),e("strong",null,a(s.deleteData.fileName),1),m(" ? ")]),e("button",{class:"btn btn-danger",onClick:n[5]||(n[5]=o=>s.deleteData=null)},[De,m(" Annuler ")]),e("a",{class:"btn btn-success",href:s.deleteData.urlDelete},[be,m(" Confirmer ")],8,ve)])])):p("",!0),s.editedDocument?(i(),l("div",ge,[e("div",ye,[e("h2",null,[e("small",null,[ke,s.mode=="new"?(i(),l("span",we,"Téléversement d'un document")):p("",!0),s.mode=="edit"?(i(),l("span",Se,"Modification des informations")):p("",!0),s.mode=="version"?(i(),l("span",Te,"Nouvelle version")):p("",!0)]),Ce,s.editedDocument.id>0?(i(),l("span",Pe,[e("strong",null,a(s.editedDocument.fileName),1)])):(i(),l("span",Ie,[m(" Nouveau document dans "),e("strong",null,a(s.editedDocument.tabDocument.label),1)])),e("span",null," ("+a(s.mode)+") ",1),e("span",{class:"overlay-closer",onClick:n[6]||(n[6]=o=>s.editedDocument=null)},"X")]),e("div",Fe,[e("div",xe,[s.mode!="edit"?(i(),l("div",Ne,[Ve,e("input",{onChange:n[7]||(n[7]=(...o)=>d.uploadFile&&d.uploadFile(...o)),type:"file",class:"form-control",name:"file",id:"file"},null,32)])):p("",!0),e("div",null,[Ue,y(f,{modelValue:s.editedDocument.dateDeposit,"onUpdate:modelValue":n[8]||(n[8]=o=>s.editedDocument.dateDeposit=o),id:"dateDeposit"},null,8,["modelValue"])]),e("div",null,[Ee,y(f,{modelValue:s.editedDocument.dateSend,"onUpdate:modelValue":n[9]||(n[9]=o=>s.editedDocument.dateSend=o),id:"dateSend"},null,8,["modelValue"])])]),e("div",Oe,[s.mode!="version"?(i(),l("div",Me,[We,e("div",null,[v(e("select",{name:"tabdocument",id:"tabdocument","onUpdate:modelValue":n[10]||(n[10]=o=>s.editedDocument.tabDocument.id=o),class:"form-control"},[(i(!0),l(_,null,D(s.tabsWithDocuments,(o,h)=>(i(),l("option",{value:h,key:h},a(o.label),9,Ae))),128))],512),[[T,s.editedDocument.tabDocument.id]])])])):p("",!0),s.mode!="version"?(i(),l("div",ze,[qe,s.editedDocument.process?(i(),l("div",je," Vous ne pouvez pas modifier le type d'un document engagé dans un processus de signature. ")):(i(),l("div",Be,[v(e("select",{class:"form-control",name:"type",id:"typedocument","onUpdate:modelValue":n[11]||(n[11]=o=>s.editedDocument.category.id=o)},[(i(!0),l(_,null,D(s.typesDocuments,(o,h)=>(i(),l("option",{value:o.id,key:o.id,disabled:o.flow&&s.editedDocument.id>0},a(o.label)+" "+a(o.flow&&s.editedDocument.id?"(signature)":""),9,Re))),128))],512),[[T,s.editedDocument.category.id]])]))])):p("",!0)]),e("div",Xe,[Le,v(e("textarea",{"onUpdate:modelValue":n[12]||(n[12]=o=>s.editedDocument.information=o),id:"information",class:"form-control"},null,512),[[V,s.editedDocument.information]])]),s.mode=="change"?(i(),l("div",Je,[e("div",Ke,[s.editedDocument.private===!1?(i(),l("span",Ge,[He,e("div",null,[v(e("select",{name:"tabdocument",id:"tabdocument","onUpdate:modelValue":n[13]||(n[13]=o=>s.editedDocument.tabDocument.id=o),class:"form-control"},[(i(!0),l(_,null,D(s.tabsWithDocuments,(o,h)=>(i(),l("option",{value:h,key:h},a(o.label),9,Qe))),128))],512),[[T,s.editedDocument.tabDocument.id]])])])):p("",!0),Ye,e("div",Ze,[v(e("input",{type:"checkbox",name:"private",id:"privateModifDoc",class:"form-control","onUpdate:modelValue":n[14]||(n[14]=o=>s.editedDocument.private=o)},null,512),[[U,s.editedDocument.private]])])]),s.editedDocument.private===!0?(i(),l("span",$e,[et,tt,y(b,{onChange:d.handlerSelectPersons},null,8,["onChange"]),(i(!0),l(_,null,D(s.editedDocument.persons,o=>(i(),l("span",{key:o.id,class:"cartouche"},[st,e("span",null,a(o.personName),1),e("span",nt,a(o.affectation),1),o.personId!==s.idCurrentPerson?(i(),l("i",{key:0,onClick:h=>d.handlerDeletePerson(o),class:"icon-trash icon-clickable"},null,8,ot)):p("",!0)]))),128))])):p("",!0)])):p("",!0)]),e("div",lt,[e("div",it,[e("nav",rt,[e("button",{class:"btn btn-danger",onClick:n[15]||(n[15]=o=>s.editedDocument=null)},[dt,m(" Annuler ")]),e("a",{class:"btn btn-success",href:"#",onClick:n[16]||(n[16]=C(o=>d.applyEdit(),["prevent"]))},[at,m(" Enregistrer ")])])])])])])):p("",!0),s.errorMessages.length!==0?(i(),l("div",ct,[e("div",ut,[e("h2",null,[e("span",{class:"overlay-closer",onClick:n[17]||(n[17]=o=>s.errorMessages=[])},"X")]),e("ul",null,[(i(!0),l(_,null,D(s.errorMessages,o=>(i(),l("li",null,a(o),1))),256))]),e("button",{class:"btn btn-danger",onClick:n[18]||(n[18]=o=>s.errorMessages=[])},[mt,m(" Retour ")])])])):p("",!0),e("section",ht,[e("div",pt,[(i(!0),l(_,null,D(d.packedDocuments,o=>(i(),l("div",{class:k(["tab",{selected:s.selectedTabId===o.id}]),onClick:C(h=>d.handlerSelectTab(o),["prevent"])},[m(a(o.label)+" ",1),e("sup",_t,a(o.total),1)],10,ft))),256)),e("div",{class:k(["tab",{selected:s.displayComputed}]),onClick:n[19]||(n[19]=C(o=>d.handlerSelectTab("computed"),["prevent"]))}," Documents générés ",2)]),v(e("div",Dt,[(i(!0),l(_,null,D(s.computedDocuments,o=>(i(),l("article",{class:"card xs",key:o.key},[e("div",vt,[bt,e("strong",null,a(o.label),1),gt]),e("nav",yt,[e("a",{class:"btn btn-default btn-xs",href:o.url},[wt,m(" Télécharger ")],8,kt)])]))),128))],512),[[I,s.displayComputed]]),(i(!0),l(_,null,D(d.packedDocuments,o=>v((i(),l("div",St,[o.manage?(i(),l("nav",Tt,[o.manage?(i(),l("button",{key:0,onClick:h=>d.handlerNew(o.id),class:"btn btn-xs btn-default"},[Pt,m(" Téléverser un document ")],8,Ct)):p("",!0)])):p("",!0),y(x,{documents:o.documents,tabs:s.tabsWithDocuments,types:s.typesDocuments,"sign-process":s.signProcess,"display-activity":!1,onFetch:d.fetch},null,8,["documents","tabs","types","sign-process","onFetch"])],512)),[[I,s.selectedTabId===o.id]])),256))])])],64)}const Ft=j(R,[["render",It],["__scopeId","data-v-504e3cfe"]]);let w=document.querySelector("#activitydocuments");const F=M(Ft,{url:w.dataset.url,urlUploadNewDoc:w.dataset.urlUploadNewDoc,urlSignDocument:w.dataset.urlSignDocument,manage:w.dataset.manage});F.config.globalProperties.$filters={timeAgo(t){return P.timeAgo(t)},date(t){return P.date(t)},dateFull(t){return P.dateFull(t)},filesize(t){return A.filesize(t)}};F.mount("#activitydocuments");
