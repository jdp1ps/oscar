import{a as b,o as r,c as a,g as u,t as h,d as t,e as c,h as f,m as y,i as O,j as w,F as _,f as v,n as V,k as S,r as k,b as z,l as I}from"../vendor.js";import{_ as x}from"../vendor3.js";import{O as L}from"../vendor2.js";const M={props:{value:{default:null}},emits:["update:value"],components:{},data(){return{options:[],lastUpdatedSearch:0,delay:null,preloadedValue:!1,selectedValue:null,selectedLabel:"",displayClosed:!1,showSelector:!1,searchFor:"",latency:null,highlightedIndex:null,loading:!1,inside:!1,displayValue:!1,error:"",hideOff:!1}},computed:{filteredOptions(){let s=[];return this.displayClosed?this.options:(this.options.forEach(e=>{e.closed||s.push(e)}),s)},optionsFiltered(){if(this.hideOff)return this.options;{let s=[];return this.options.forEach(e=>{e.closed||s.push(e)}),s}}},mounted(){document.addEventListener("click",this.handlerGlobalClick,!0),this.value},methods:{handlerGlobalClick(s){this.inside?(this.displayValue=!1,this.showSelector=!0):(this.showSelector=!1,this.displayValue=!0)},handlerMouseLeave(){this.inside=!1},handlerMouseEnter(){this.inside=!0},handlerClick(s){this.displayValue=!1},handlerUnselect(){this.selectedValue=null,this.selectedLabel="",this.showSelector=!1,this.displayValue=!1,this.$emit("change",null),this.$emit("update:value",null),this.$emit("input",null)},handlerSelectIndex(s){this.options.forEach(e=>{e.id==s&&(this.selectedValue=e.id,this.selectedLabel=e.label,this.showSelector=!1,this.displayValue=!0)}),this.$emit("change",{id:this.selectedValue,label:this.selectedLabel}),this.$emit("update:value",this.selectedValue),this.$emit("input",this.selectedValue)},handlerSelectPrev(s=!1){if(this.highlightedIndex==0&&(this.showSelector=!1),this.highlightedIndex>0&&(this.showSelector||(this.showSelector=!0),this.highlightedIndex--),s==!0){let e="#item_"+this.highlightedIndex,d=this.$el.querySelector(e),g=this.$el.querySelectorAll(".options")[0];g.scrollTop=d.offsetTop,console.log("SCROLL",g.scrollTop),console.log("ITEM",e,d)}},handlerSelectNext(s=!1){if(this.showSelector?this.highlightedIndex<this.options.length-1&&this.highlightedIndex++:this.showSelector=!0,s==!0){let e="#item_"+this.highlightedIndex,d=this.$el.querySelector(e),g=this.$el.querySelectorAll(".options")[0];g.scrollTop=d.offsetTop,console.log("SCROLL",g.scrollTop),console.log("ITEM",e,d)}},updateSelectedDate(){},handlerKeyUp(s){switch(s.code){case"ArrowUp":this.handlerSelectPrev(!0);break;case"ArrowDown":this.handlerSelectNext(!0);break;case"ArrowLeft":case"ArrowRight":break;case"Enter":s.preventDefault(),this.handlerSelectIndex(this.highlightedIndex);break;default:this.searchFor&&this.searchFor.length>1&&this.handlerChange()}},handlerChange(s){this.latency!=null&&clearTimeout(this.latency);let e=function(){this.search(),clearTimeout(this.latency)}.bind(this);this.latency=setTimeout(e,1e3)},search(){this.loading=!0,this.showSelector=!1,b.get("/organization?f=json&l=m&q="+encodeURI(this.searchFor)).then(s=>{this.options=s.data.datas,this.options.length>0&&(this.highlightedIndex=0,this.showSelector=!0)},s=>{switch(console.log(s),s.status){case 401:case 403:this.error="Vous avez été déconnecté (actualisé votre page pour vous reconnecter)";break;case 500:this.error="La recherche a provoqué une erreur";break;default:this.error="Un problème inconnu est survenu"}}).then(s=>{this.loading=!1})},setSelected(s){console.log("setSelected",s),this.value=s,this.$emit("change",this.value),this.$emit("input",this.value)},handlerSearchOrganisation(s,e){if(s.length){e(!0);let d=function(){this.searchOrganization(e,s,this),this.delay=null}.bind(this);this.delay!=null&&clearTimeout(this.delay),this.delay=setTimeout(d,1e3)}}}},T={class:"input-group",style:{position:"relative"}},F={key:0,class:"displayed-value text-danger",style:{}},U=t("i",{class:"icon-attention-1"},null,-1),E={key:1,class:"displayed-value",style:{}},R={class:"input-group-addon"},A={class:"icon-spinner animate-spin"},D={class:"icon-building-filled"},N={class:"options"},q={for:"hidder"},j=["onMouseover","onClick","id"],K={class:"option-title"},B={class:"cartouche code"},P={class:"fullname"},G={key:0},H={key:0,class:"option-infos"},J=t("i",{class:"icon-location"},null,-1);function Q(s,e,d,g,l,i){return r(),a("div",{class:"oscar-selector organization-selector",onClick:e[5]||(e[5]=(...n)=>i.handlerClick&&i.handlerClick(...n)),onMouseleave:e[6]||(e[6]=(...n)=>i.handlerMouseLeave&&i.handlerMouseLeave(...n)),onMouseenter:e[7]||(e[7]=(...n)=>i.handlerMouseEnter&&i.handlerMouseEnter(...n))},[u(" hop "+h(l.selectedValue)+" ",1),t("div",T,[l.error?(r(),a("div",F,[U,u(" "+h(l.error)+" ",1),t("i",{onClick:e[0]||(e[0]=n=>l.error=""),class:"icon-cancel-circled-outline button-cancel-value"})])):c("",!0),l.displayValue?(r(),a("div",E,[u(h(l.selectedLabel)+" ",1),l.selectedValue?(r(),a("i",{key:0,onClick:e[1]||(e[1]=(...n)=>i.handlerUnselect&&i.handlerUnselect(...n)),class:"icon-cancel-circled-outline button-cancel-value"})):c("",!0)])):c("",!0),t("span",R,[f(t("i",A,null,512),[[y,l.loading]]),f(t("i",D,null,512),[[y,!l.loading]])]),f(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=n=>l.searchFor=n),onKeyup:e[3]||(e[3]=(...n)=>i.handlerKeyUp&&i.handlerKeyUp(...n)),placeholder:"Rechercher une organisation...",class:"form-control"},null,544),[[O,l.searchFor]])]),f(t("div",N,[t("header",null,[u(" Résultat(s) : "+h(l.options.length)+" / ",1),t("label",q,[u(" Afficher les structures fermées "),f(t("input",{type:"checkbox",id:"hidder",value:"on","onUpdate:modelValue":e[4]||(e[4]=n=>l.hideOff=n)},null,512),[[w,l.hideOff]])])]),(r(!0),a(_,null,v(i.optionsFiltered,(n,m)=>(r(),a("div",{class:V(["option",{active:m==l.highlightedIndex,selected:n.id==l.selectedValue,closed:n.closed}]),onMouseover:o=>l.highlightedIndex=m,onClick:S(o=>i.handlerSelectIndex(n.id),["prevent","stop"]),id:"item_"+m},[t("div",K,[t("em",B,h(n.code),1),t("span",P,[t("strong",null,h(n.shortname),1),t("em",null,h(n.longname),1)]),n.type?(r(),a("span",G," ("+h(n.type)+") ",1)):c("",!0)]),n.city||n.country?(r(),a("div",H,[t("small",null,[J,u(" "+h(n.city)+" - "+h(n.country),1)])])):c("",!0)],42,j))),256))],512),[[y,l.showSelector&&l.options.length]])],32)}const W=x(M,[["render",Q]]);const X={props:{url:{require:!0},manageSubOragnization:{default:!0}},components:{OrganizationAutoComplete:W,OscarDialog:L},data(){return{selectedId:null,remote:"Initialisation",error:"",organizations:[],manageSubOragnization:null,dialogDelete:null}},methods:{fetch(){this.remote="Chargement des sous-structures",b.get(this.url).then(s=>{this.remote="",this.organizations=s.data.organizations},s=>{this.remote="",this.error="Impossible de charger les sous-structures : "+s.response.data})},handlerNew(){this.manageSubOragnization={idOrganization:null}},handlerRemoveSubStructure(s){this.remote="Suppression de la sous-structure",this.dialogDelete={dispayed:!0,title:"Suppression de la sous-structure",message:"Retirer '"+s.label+"' des sous-structures ?",onSuccess:()=>{console.log("sub structure",s),this.remote="Suppression de la sous-structure",b.delete(this.url+"?idsubstructure="+s.id).then(e=>{this.remote="",this.fetch()},e=>{this.remote="",this.error="Impossible de supprimer la sous-structure : "+e.response.data}).finally(e=>{this.manageSubOragnization=null})}}},handlerChange(s){this.manageSubOragnization.idOrganization=s.id},handlerSave(){this.remote="Chargement des sous-structures";let s=new FormData;s.append("idSubStructure",this.manageSubOragnization.idOrganization),b.post(this.url,s).then(e=>{this.remote="",this.fetch()},e=>{this.remote="",this.error=e.response.data}).finally(e=>{this.manageSubOragnization=null})}},mounted(){this.fetch()}},Y={key:0},Z={key:1,class:"overlay"},$={class:"overlay-content",style:{overflow:"visible"}},ee=t("h2",null,"Nouvelle sous-structure",-1),te={class:"buttons-bar"},se=t("i",{class:"icon-cancel-circled"},null,-1),le=t("i",{class:"icon-floppy"},null,-1),ne={key:2,class:"alert alert-danger"},ie=t("hr",null,null,-1),oe={class:"suborganizations"},re={class:"card suborganization"},ae={class:"card-title"},he={class:"organization-code code"},ue={class:"organization-shortname"},ce={class:"card-title-subsection"},de={class:"organization-longname"},ge={key:0,class:"card-content"},pe=t("h4",null," Personnel ",-1),me=t("i",{class:"icon-user"},null,-1),fe={key:0},_e={key:1,class:"card-content suborganizations"},be=t("h4",null," Sous-structure ",-1),ve=t("i",{class:"icon-building"},null,-1),ye={class:"card-footer buttons-bar"},Se=["href"],ke=t("i",{class:"icon-link-outline"},null,-1),ze=["onClick"],Ce=t("i",{class:"icon-trash"},null,-1);function xe(s,e,d,g,l,i){const n=k("oscar-dialog"),m=k("organization-auto-complete");return r(),a(_,null,[l.remote?(r(),a("div",Y,' Message: "'+h(l.remote)+'" // URL: "'+h(d.url)+'" ',1)):c("",!0),z(n,{options:l.dialogDelete},null,8,["options"]),l.manageSubOragnization?(r(),a("div",Z,[t("div",$,[ee,z(m,{modelValue:l.manageSubOragnization.selectedId,"onUpdate:modelValue":e[0]||(e[0]=o=>l.manageSubOragnization.selectedId=o),onChange:i.handlerChange},null,8,["modelValue","onChange"]),t("div",te,[t("button",{class:"btn btn-danger",onClick:e[1]||(e[1]=o=>l.manageSubOragnization=null)},[se,u(" Annuler ")]),t("button",{class:"btn btn-success",onClick:e[2]||(e[2]=(...o)=>i.handlerSave&&i.handlerSave(...o))},[le,u(" Enregistrer ")])])])])):c("",!0),l.error?(r(),a("div",ne,[u(h(l.error)+" ",1),ie,t("a",{href:"#",onClick:e[3]||(e[3]=S(o=>l.error="",["prevent"]))},"Fermer")])):c("",!0),t("section",oe,[(r(!0),a(_,null,v(l.organizations,o=>(r(),a("article",re,[t("h2",ae,[t("code",he,h(o.code),1),t("strong",ue,h(o.shortname),1),t("div",ce,[t("i",de,h(o.longname),1)])]),o.persons.length!=0?(r(),a("section",ge,[pe,(r(!0),a(_,null,v(o.persons,p=>(r(),a("div",null,[me,t("strong",null,h(p.label),1),p.roles.length?(r(),a("em",fe," ("+h(p.roles.join(", "))+") ",1)):c("",!0)]))),256))])):c("",!0),o.organizations.length!=0?(r(),a("section",_e,[be,(r(!0),a(_,null,v(o.organizations,p=>(r(),a("div",null,[ve,t("strong",null,h(p.shortname),1),u("   "),t("em",null,h(p.longname),1)]))),256))])):c("",!0),t("nav",ye,[t("a",{href:o.show,class:"btn btn-info btn-xs"},[ke,u(" Voir la fiche ")],8,Se),t("a",{href:"#",class:"btn btn-danger btn-xs",onClick:S(p=>i.handlerRemoveSubStructure(o),["prevent"])},[Ce,u(" Retirer ")],8,ze)])]))),256))]),t("button",{class:"btn btn-primary",onClick:e[4]||(e[4]=(...o)=>i.fetch&&i.fetch(...o))}," Recharger "),t("button",{class:"btn btn-primary",onClick:e[5]||(e[5]=(...o)=>i.handlerNew&&i.handlerNew(...o))}," Ajouter une sous-structure ")],64)}const Oe=x(X,[["render",xe]]);let C=document.querySelector("#suborganizations");const we=I(Oe,{url:C.dataset.url,manage:C.dataset.manage});we.mount("#suborganizations");
