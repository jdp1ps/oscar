import{a as f,o as r,c as a,g as u,t as h,d as s,e as d,h as m,m as y,i as w,j as x,F as _,f as b,n as V,k as C,r as S,b as k,l as I}from"../vendor.js";import{_ as O}from"../vendor3.js";import{O as E}from"../vendor2.js";const L={props:{value:{default:null}},emits:["update:value"],components:{},data(){return{options:[],lastUpdatedSearch:0,delay:null,preloadedValue:!1,selectedValue:null,selectedLabel:"",displayClosed:!1,showSelector:!1,searchFor:"",latency:null,highlightedIndex:null,loading:!1,inside:!1,displayValue:!1,error:"",hideOff:!1}},computed:{filteredOptions(){let t=[];return this.displayClosed?this.options:(this.options.forEach(e=>{e.closed||t.push(e)}),t)},optionsFiltered(){if(this.hideOff)return this.options;{let t=[];return this.options.forEach(e=>{e.closed||t.push(e)}),t}}},mounted(){document.addEventListener("click",this.handlerGlobalClick,!0),this.value},methods:{handlerGlobalClick(t){this.inside?(this.displayValue=!1,this.showSelector=!0):(this.showSelector=!1,this.displayValue=!0)},handlerMouseLeave(){this.inside=!1},handlerMouseEnter(){this.inside=!0},handlerClick(t){this.displayValue=!1},handlerUnselect(){this.selectedValue=null,this.selectedLabel="",this.showSelector=!1,this.displayValue=!1,this.$emit("change",null),this.$emit("update:value",null),this.$emit("input",null)},handlerSelectIndex(t){this.options.forEach(e=>{e.id==t&&(this.selectedValue=e.id,this.selectedLabel=e.label,this.showSelector=!1,this.displayValue=!0)}),this.$emit("change",{id:this.selectedValue,label:this.selectedLabel}),this.$emit("update:value",this.selectedValue),this.$emit("input",this.selectedValue)},handlerSelectPrev(t=!1){if(this.highlightedIndex==0&&(this.showSelector=!1),this.highlightedIndex>0&&(this.showSelector||(this.showSelector=!0),this.highlightedIndex--),t==!0){let e="#item_"+this.highlightedIndex,c=this.$el.querySelector(e),g=this.$el.querySelectorAll(".options")[0];g.scrollTop=c.offsetTop,console.log("SCROLL",g.scrollTop),console.log("ITEM",e,c)}},handlerSelectNext(t=!1){if(this.showSelector?this.highlightedIndex<this.options.length-1&&this.highlightedIndex++:this.showSelector=!0,t==!0){let e="#item_"+this.highlightedIndex,c=this.$el.querySelector(e),g=this.$el.querySelectorAll(".options")[0];g.scrollTop=c.offsetTop,console.log("SCROLL",g.scrollTop),console.log("ITEM",e,c)}},updateSelectedDate(){},handlerKeyUp(t){switch(t.code){case"ArrowUp":this.handlerSelectPrev(!0);break;case"ArrowDown":this.handlerSelectNext(!0);break;case"ArrowLeft":case"ArrowRight":break;case"Enter":t.preventDefault(),this.handlerSelectIndex(this.highlightedIndex);break;default:this.searchFor&&this.searchFor.length>1&&this.handlerChange()}},handlerChange(t){this.latency!=null&&clearTimeout(this.latency);let e=function(){this.search(),clearTimeout(this.latency)}.bind(this);this.latency=setTimeout(e,1e3)},search(){this.loading=!0,this.showSelector=!1,f.get("/organization?f=json&l=m&q="+encodeURI(this.searchFor)).then(t=>{this.options=t.data.datas,this.options.length>0&&(this.highlightedIndex=0,this.showSelector=!0)},t=>{switch(console.log(t),t.status){case 401:case 403:this.error="Vous avez été déconnecté (actualisé votre page pour vous reconnecter)";break;case 500:this.error="La recherche a provoqué une erreur";break;default:this.error="Un problème inconnu est survenu"}}).then(t=>{this.loading=!1})},setSelected(t){console.log("setSelected",t),this.value=t,this.$emit("change",this.value),this.$emit("input",this.value)},handlerSearchOrganisation(t,e){if(t.length){e(!0);let c=function(){this.searchOrganization(e,t,this),this.delay=null}.bind(this);this.delay!=null&&clearTimeout(this.delay),this.delay=setTimeout(c,1e3)}}}},M={class:"input-group",style:{position:"relative"}},R={key:0,class:"displayed-value text-danger",style:{}},T=s("i",{class:"icon-attention-1"},null,-1),U={key:1,class:"displayed-value",style:{}},F={class:"input-group-addon"},A={class:"icon-spinner animate-spin"},D={class:"icon-building-filled"},N={class:"options"},q={for:"hidder"},j=["onMouseover","onClick","id"],K={class:"option-title"},B={class:"cartouche code"},P={class:"fullname"},G={key:0},H={key:0,class:"option-infos"},J=s("i",{class:"icon-location"},null,-1);function Q(t,e,c,g,n,i){return r(),a("div",{class:"oscar-selector organization-selector",onClick:e[5]||(e[5]=(...l)=>i.handlerClick&&i.handlerClick(...l)),onMouseleave:e[6]||(e[6]=(...l)=>i.handlerMouseLeave&&i.handlerMouseLeave(...l)),onMouseenter:e[7]||(e[7]=(...l)=>i.handlerMouseEnter&&i.handlerMouseEnter(...l))},[u(" hop "+h(n.selectedValue)+" ",1),s("div",M,[n.error?(r(),a("div",R,[T,u(" "+h(n.error)+" ",1),s("i",{onClick:e[0]||(e[0]=l=>n.error=""),class:"icon-cancel-circled-outline button-cancel-value"})])):d("",!0),n.displayValue?(r(),a("div",U,[u(h(n.selectedLabel)+" ",1),n.selectedValue?(r(),a("i",{key:0,onClick:e[1]||(e[1]=(...l)=>i.handlerUnselect&&i.handlerUnselect(...l)),class:"icon-cancel-circled-outline button-cancel-value"})):d("",!0)])):d("",!0),s("span",F,[m(s("i",A,null,512),[[y,n.loading]]),m(s("i",D,null,512),[[y,!n.loading]])]),m(s("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=l=>n.searchFor=l),onKeyup:e[3]||(e[3]=(...l)=>i.handlerKeyUp&&i.handlerKeyUp(...l)),placeholder:"Rechercher une organisation...",class:"form-control"},null,544),[[w,n.searchFor]])]),m(s("div",N,[s("header",null,[u(" Résultat(s) : "+h(n.options.length)+" / ",1),s("label",q,[u(" Afficher les structures fermées "),m(s("input",{type:"checkbox",id:"hidder",value:"on","onUpdate:modelValue":e[4]||(e[4]=l=>n.hideOff=l)},null,512),[[x,n.hideOff]])])]),(r(!0),a(_,null,b(i.optionsFiltered,(l,p)=>(r(),a("div",{class:V(["option",{active:p==n.highlightedIndex,selected:l.id==n.selectedValue,closed:l.closed}]),onMouseover:o=>n.highlightedIndex=p,onClick:C(o=>i.handlerSelectIndex(l.id),["prevent","stop"]),id:"item_"+p},[s("div",K,[s("em",B,h(l.code),1),s("span",P,[s("strong",null,h(l.shortname),1),s("em",null,h(l.longname),1)]),l.type?(r(),a("span",G," ("+h(l.type)+") ",1)):d("",!0)]),l.city||l.country?(r(),a("div",H,[s("small",null,[J,u(" "+h(l.city)+" - "+h(l.country),1)])])):d("",!0)],42,j))),256))],512),[[y,n.showSelector&&n.options.length]])],32)}const W=O(L,[["render",Q]]);const X={props:{url:{require:!0},manageSubOragnization:{default:!0}},components:{OrganizationAutoComplete:W,OscarDialog:E},data(){return{selectedId:null,remote:"Initialisation",organizations:[],manageSubOragnization:null,dialogDelete:null}},methods:{fetch(){this.remote="Chargement des sous-structures",f.get(this.url).then(t=>{this.remote="",this.organizations=t.data.organizations},t=>{this.remote="Erreur de chargement",console.log("ERREUR",t)})},handlerNew(){this.manageSubOragnization={idOrganization:null}},handlerRemoveSubStructure(t){this.remote="Suppression de la sous-structure",this.dialogDelete={dispayed:!0,title:"Suppression de la sous-structure",message:"Retirer '"+t.label+"' des sous-structures ?",onSuccess:()=>{console.log("sub structure",t),this.remote="Suppression de la sous-structure",f.delete(this.url+"?idsubstructure="+t.id).then(e=>{this.remote="",this.fetch()},e=>{this.remote="Erreur"}).finally(e=>{this.manageSubOragnization=null})}}},handlerChange(t){this.manageSubOragnization.idOrganization=t.id},handlerSave(){this.remote="Chargement des sous-structures";let t=new FormData;t.append("idSubStructure",this.manageSubOragnization.idOrganization),f.post(this.url,t).then(e=>{this.remote="",this.fetch()},e=>{this.remote="Erreur ajout..."}).finally(e=>{this.manageSubOragnization=null})}},mounted(){this.fetch()}},Y={key:0},Z={key:1,class:"overlay"},$={class:"overlay-content",style:{overflow:"visible"}},ee=s("h2",null,"Nouvelle sous-structure",-1),te={class:"buttons-bar"},se=s("i",{class:"icon-cancel-circled"},null,-1),le=s("i",{class:"icon-floppy"},null,-1),ne={class:"suborganizations"},ie={class:"card suborganization"},oe={class:"card-title"},re=["href"],ae=s("i",{class:"icon-link-outline"},null,-1),he=["onClick"],ue=s("i",{class:"icon-trash"},null,-1),ce={key:0,class:"card-content"},de={class:"cartouche"},ge=s("i",{class:"icon-user"},null,-1),pe={class:"addon"},me={key:1,class:"card-content"};function fe(t,e,c,g,n,i){const l=S("oscar-dialog"),p=S("organization-auto-complete");return r(),a(_,null,[n.remote?(r(),a("div",Y,' Message: "'+h(n.remote)+'" // URL: "'+h(c.url)+'" ',1)):d("",!0),k(l,{options:n.dialogDelete},null,8,["options"]),n.manageSubOragnization?(r(),a("div",Z,[s("div",$,[ee,k(p,{modelValue:n.manageSubOragnization.selectedId,"onUpdate:modelValue":e[0]||(e[0]=o=>n.manageSubOragnization.selectedId=o),onChange:i.handlerChange},null,8,["modelValue","onChange"]),s("div",te,[s("button",{class:"btn btn-danger",onClick:e[1]||(e[1]=o=>n.manageSubOragnization=null)},[se,u(" Annuler ")]),s("button",{class:"btn btn-success",onClick:e[2]||(e[2]=(...o)=>i.handlerSave&&i.handlerSave(...o))},[le,u(" Enregistrer ")])])])])):d("",!0),s("section",ne,[(r(!0),a(_,null,b(n.organizations,o=>(r(),a("article",ie,[s("h2",oe,[s("i",null,h(o.code),1),s("strong",null,h(o.label),1),s("a",{href:o.show},[ae,u(" Voir la fiche")],8,re),s("a",{href:"#",onClick:C(v=>i.handlerRemoveSubStructure(o),["prevent"])},[ue,u(" Retirer")],8,he)]),o.persons?(r(),a("section",ce,[u(" Personnel : "),(r(!0),a(_,null,b(o.persons,v=>(r(),a("span",de,[ge,u(" "+h(v.label)+" ",1),s("span",pe,h(v.roles.join(", ")),1)]))),256))])):d("",!0),o.organizations?(r(),a("section",me," Sous-structures : ")):d("",!0)]))),256))]),s("button",{class:"btn btn-primary",onClick:e[3]||(e[3]=(...o)=>i.fetch&&i.fetch(...o))}," Recharger "),s("button",{class:"btn btn-primary",onClick:e[4]||(e[4]=(...o)=>i.handlerNew&&i.handlerNew(...o))}," Ajouter une sous-structure ")],64)}const _e=O(X,[["render",fe]]);let z=document.querySelector("#suborganizations");const ve=I(_e,{url:z.dataset.url,manage:z.dataset.manage});ve.mount("#suborganizations");
